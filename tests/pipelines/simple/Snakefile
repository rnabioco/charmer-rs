# Simple test pipeline for charmer development
# Simulates a basic bioinformatics workflow (~2 minutes with 2 cores)

SAMPLES = ["sample1", "sample2", "sample3", "sample4"]
CHROMOSOMES = ["chr1", "chr2", "chr3"]

rule all:
    input:
        "results/final_report.txt"

rule process_sample:
    """Initial sample processing - runs first for all samples."""
    output:
        "results/processed/{sample}.txt"
    params:
        delay = 5
    shell:
        """
        echo "Processing {wildcards.sample}..."
        sleep {params.delay}
        echo "Processed: {wildcards.sample}" > {output}
        """

rule align_sample:
    """Alignment step - depends on processing."""
    input:
        "results/processed/{sample}.txt"
    output:
        "results/aligned/{sample}.bam"
    params:
        delay = 8
    shell:
        """
        echo "Aligning {wildcards.sample}..."
        sleep {params.delay}
        echo "Aligned: {wildcards.sample}" > {output}
        """

rule call_variants:
    """Variant calling per chromosome - depends on alignment."""
    input:
        bam = "results/aligned/{sample}.bam"
    output:
        vcf = "results/variants/{sample}_{chrom}.vcf"
    params:
        delay = 6
    shell:
        """
        echo "Calling variants for {wildcards.sample} on {wildcards.chrom}..."
        sleep {params.delay}
        echo "Variants: {wildcards.sample} {wildcards.chrom}" > {output.vcf}
        """

rule merge_sample_variants:
    """Merge variants per sample across chromosomes."""
    input:
        expand("results/variants/{{sample}}_{chrom}.vcf", chrom=CHROMOSOMES)
    output:
        "results/merged/{sample}_merged.vcf"
    params:
        delay = 4
    shell:
        """
        echo "Merging variants for {wildcards.sample}..."
        sleep {params.delay}
        cat {input} > {output}
        """

rule final_merge:
    """Final merge of all sample variants."""
    input:
        expand("results/merged/{sample}_merged.vcf", sample=SAMPLES)
    output:
        "results/all_variants.vcf"
    params:
        delay = 5
    shell:
        """
        echo "Final merge of all variants..."
        sleep {params.delay}
        cat {input} > {output}
        """

rule generate_report:
    """Generate final pipeline report."""
    input:
        vcf = "results/all_variants.vcf",
        bams = expand("results/aligned/{sample}.bam", sample=SAMPLES)
    output:
        "results/final_report.txt"
    params:
        delay = 3
    shell:
        """
        echo "Generating final report..."
        sleep {params.delay}
        echo "=== Pipeline Complete ===" > {output}
        echo "Samples: {SAMPLES}" >> {output}
        echo "Chromosomes: {CHROMOSOMES}" >> {output}
        echo "Total jobs: $(find results -type f | wc -l)" >> {output}
        date >> {output}
        """
